<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAPT Admin | Control Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root { --bg: #050505; --gold: #D4AF37; --panel: #111; --border: #333; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        /* LOGIN SCREEN */
        #login-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { border: 1px solid var(--gold); padding: 40px; border-radius: 10px; text-align: center; }
        .login-box input { background: #222; border: 1px solid #444; padding: 10px; color: white; margin-bottom: 10px; width: 200px; display: block; }
        .login-box button { background: var(--gold); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; width: 100%; }

        /* DASHBOARD LAYOUT */
        .admin-container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; }
        .logo { font-family: 'Syncopate', sans-serif; font-size: 1.5rem; margin-bottom: 40px; display: block; }
        .nav-btn { display: block; width: 100%; padding: 15px; background: transparent; border: none; color: #888; text-align: left; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .nav-btn:hover, .nav-btn.active { color: var(--gold); background: rgba(255,255,255,0.05); border-left: 3px solid var(--gold); }
        
        .content-area { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        h2 { font-family: 'Syncopate', sans-serif; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; color: var(--gold); }

        /* FORMS & INPUTS */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
        input, textarea, select { width: 100%; background: #1a1a1a; border: 1px solid var(--border); padding: 12px; color: white; border-radius: 5px; outline: none; }
        input:focus { border-color: var(--gold); }
        .btn-gold { background: var(--gold); color: black; border: none; padding: 12px 24px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        
        /* DATA TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); }
        th { color: var(--gold); font-size: 0.8rem; text-transform: uppercase; }
        td { font-size: 0.9rem; color: #ccc; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase; }
        .status-new { background: rgba(0, 255, 0, 0.1); color: #0f0; }

        /* IMAGE PREVIEW GRID */
        .img-preview-grid { display: flex; gap: 10px; margin-top: 10px; }
        .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #444; }

        /* TOAST NOTIFICATION */
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--gold); color: black; padding: 15px 30px; border-radius: 5px; font-weight: bold; transform: translateY(100px); transition: 0.3s; }
        #toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="logo">TAPT<span>.</span> ADMIN</div>
        <div class="login-box">
            <input type="password" id="admin-pass" placeholder="Enter Admin Password">
            <button onclick="checkAdmin()">LOGIN</button>
        </div>
    </div>

    <div class="admin-container" style="display:none;" id="dashboard-ui">
        
        <div class="sidebar">
            <div class="logo">TAPT<span>.</span></div>
            <button class="nav-btn active" onclick="showSection('orders')"><i class="fa-solid fa-cart-shopping"></i> Orders</button>
            <button class="nav-btn" onclick="showSection('products')"><i class="fa-solid fa-box-open"></i> Products</button>
            <button class="nav-btn" onclick="showSection('coupons')"><i class="fa-solid fa-ticket"></i> Coupons</button>
            <button class="nav-btn" style="margin-top: 50px; color: #ff5555;" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>

        <div class="content-area">
            
            <div id="orders" class="section active">
                <h2>Recent Orders</h2>
                <div id="orders-list">
                    <table>
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="products" class="section">
                <h2>Manage Products</h2>
                
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="margin-top:0;">Add New Product</h3>
                    <div class="form-group">
                        <label>Product Title</label>
                        <input type="text" id="p-title" placeholder="e.g. The Executive Black">
                    </div>
                    <div class="form-group">
                        <label>Price (₹)</label>
                        <input type="number" id="p-price" placeholder="1999">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="p-category">
                            <option value="business">Business</option>
                            <option value="medical">Medical</option>
                            <option value="gaming">Gaming</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Product Images (Select Multiple)</label>
                        <input type="file" id="p-images" multiple accept="image/*">
                        <div class="img-preview-grid" id="image-previews"></div>
                    </div>
                    <button class="btn-gold" onclick="uploadProduct()">UPLOAD PRODUCT</button>
                    <p id="upload-status" style="margin-top:10px; color:#888; font-size:0.8rem;"></p>
                </div>

                <h3>Current Inventory</h3>
                <div id="products-list-container">
                    </div>
            </div>

            <div id="coupons" class="section">
                <h2>Coupon Manager</h2>
                
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="margin-top:0;">Create Coupon</h3>
                    <div class="form-group">
                        <label>Code Name (e.g. SALE20)</label>
                        <input type="text" id="c-code" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Discount Type</label>
                        <select id="c-type">
                            <option value="percentage">Percentage Off (%)</option>
                            <option value="flat">Flat Amount Off (₹)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value (e.g. 20 for 20%)</label>
                        <input type="number" id="c-value">
                    </div>
                    <div class="form-group">
                        <label>Limit Usage</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" checked disabled style="width:auto;"> 
                            <span style="font-size:0.9rem; color:#888;">Strict Limit: 1 use per customer email</span>
                        </div>
                    </div>
                    <button class="btn-gold" onclick="createCoupon()">SAVE COUPON</button>
                </div>

                <h3>Active Coupons</h3>
                <table id="coupons-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Used By</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="coupons-body"></tbody>
                </table>
            </div>

        </div>
    </div>

    <div id="toast">Action Successful</div>

   <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        /* --- CONFIGURATION --- */
        const firebaseConfig = {
            apiKey: "AIzaSyBmCVQan3wclKDTG2yYbCf_oMO6t0j17wI",
            authDomain: "tapt-337b8.firebaseapp.com",
            
            // --- THIS WAS MISSING ---
            databaseURL: "https://tapt-337b8-default-rtdb.firebaseio.com/", 
            // ------------------------

            projectId: "tapt-337b8",
            storageBucket: "tapt-337b8.firebasestorage.app",
            messagingSenderId: "887956121124",
            appId: "1:887956121124:web:6856680bf75aa3bacddab1",
            measurementId: "G-2CB8QXYNJY"
        };

        // Initialize Firebase (Only do this ONCE)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // YOUR IMGBB KEY (You need to paste this from imgbb.com)
        const IMG_BB_API_KEY = "PASTE_YOUR_IMGBB_KEY_HERE"; 

        /* --- AUTHENTICATION --- */
        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            // Simple hardcoded password
            if(pass === "admin123") { 
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard-ui').style.display = 'flex';
                loadAllData();
            } else {
                alert("Wrong Password");
            }
        }

        function logout() {
            location.reload();
        }

        /* --- NAVIGATION --- */
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Fix for event.target being undefined if called manually
            if(event) event.currentTarget.classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function loadAllData() {
            loadProducts();
            loadOrders();
            loadCoupons();
        }

        /* --- 1. PRODUCT MANAGEMENT --- */
        async function uploadProduct() {
            const title = document.getElementById('p-title').value;
            const price = document.getElementById('p-price').value;
            const category = document.getElementById('p-category').value;
            const files = document.getElementById('p-images').files;
            const statusText = document.getElementById('upload-status');

            if(!title || !price || files.length === 0) {
                alert("Please fill all fields and select at least 1 image");
                return;
            }

            statusText.textContent = "Uploading images...";
            let imageUrls = [];

            // Upload to ImgBB
            for(let i=0; i<files.length; i++) {
                const formData = new FormData();
                formData.append("image", files[i]);
                
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_API_KEY}`, {
                        method: "POST",
                        body: formData
                    });
                    const data = await response.json();
                    if(data.success) {
                        imageUrls.push(data.data.url);
                    } else {
                        console.error("ImgBB Error", data);
                        statusText.textContent = "Error uploading image.";
                        return;
                    }
                } catch(err) {
                    console.error(err);
                    statusText.textContent = "Network Error.";
                    return;
                }
            }

            // Save to Firebase
            const newProductRef = db.ref('products').push();
            newProductRef.set({
                title: title,
                price: parseFloat(price),
                category: category,
                images: imageUrls,
                createdAt: new Date().toISOString()
            }, (error) => {
                if (error) {
                    statusText.textContent = "Database Error: " + error.message;
                } else {
                    statusText.textContent = "";
                    showToast("Product Added!");
                    // Clear inputs
                    document.getElementById('p-title').value = "";
                    document.getElementById('p-price').value = "";
                    document.getElementById('p-images').value = "";
                    loadProducts(); 
                }
            });
        }

        function loadProducts() {
            const container = document.getElementById('products-list-container');
            container.innerHTML = "<p>Loading...</p>";
            
            db.ref('products').on('value', (snapshot) => {
                container.innerHTML = "";
                if(!snapshot.exists()) {
                    container.innerHTML = "<p>No products yet.</p>";
                    return;
                }
                snapshot.forEach((childSnapshot) => {
                    const p = childSnapshot.val();
                    const key = childSnapshot.key;
                    const img = (p.images && p.images.length > 0) ? p.images[0] : '';
                    
                    const div = document.createElement('div');
                    div.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; margin-bottom:10px; border-radius:5px;";
                    div.innerHTML = `
                        <div style="display:flex; gap:15px; align-items:center;">
                            <img src="${img}" style="width:50px; height:50px; border-radius:5px; object-fit:cover; background:#333;">
                            <div>
                                <strong>${p.title}</strong><br>
                                <span style="color:#888;">₹${p.price} | ${p.category}</span>
                            </div>
                        </div>
                        <button onclick="deleteProduct('${key}')" style="background:#ff5555; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Delete</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function deleteProduct(key) {
            if(confirm("Delete this product?")) {
                db.ref('products/' + key).remove();
            }
        }

        /* --- 2. COUPONS --- */
        function createCoupon() {
            const code = document.getElementById('c-code').value.toUpperCase().trim();
            const type = document.getElementById('c-type').value;
            const value = document.getElementById('c-value').value;

            if(!code || !value) return alert("Enter details");

            db.ref('coupons/' + code).set({
                type: type,
                value: parseFloat(value)
            });
            showToast("Coupon Saved");
            document.getElementById('c-code').value = "";
        }

        function loadCoupons() {
            const tbody = document.getElementById('coupons-body');
            db.ref('coupons').on('value', (snapshot) => {
                tbody.innerHTML = "";
                snapshot.forEach((child) => {
                    const c = child.val();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="color:var(--gold);">${child.key}</td>
                        <td>${c.type === 'percentage' ? c.value + '%' : '₹' + c.value}</td>
                        <td>-</td>
                        <td><button onclick="db.ref('coupons/${child.key}').remove()" style="color:#f55; background:none; border:none; cursor:pointer;">X</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        /* --- 3. ORDERS --- */
        function loadOrders() {
            const tbody = document.getElementById('orders-table-body');
            db.ref('orders').on('value', (snapshot) => {
                tbody.innerHTML = "";
                snapshot.forEach((child) => {
                    const o = child.val();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${child.key.substring(0,6)}</td>
                        <td>${o.shipping.firstName}<br><small>${o.contactEmail}</small></td>
                        <td>${o.items ? o.items.length : 0} Items</td>
                        <td style="color:var(--gold);">₹${o.total}</td>
                        <td><span class="status-badge status-new">PAID</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }
    </script>
